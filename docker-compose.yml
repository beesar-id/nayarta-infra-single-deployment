
# =============================================================================
# NAYARTA VMS - Main Docker Compose (Include-based)
# =============================================================================
#
# USAGE:
# ------
# 1. Run ALL services:
#    docker-compose --profile all up -d
#
# 2. Run specific profiles:
#    docker-compose --profile database up -d
#    docker-compose --profile storage up -d
#    docker-compose --profile stream up -d
#    docker-compose --profile app up -d
#    docker-compose --profile appstack up -d
#    docker-compose --profile analytics up -d
#    docker-compose --profile rabbitmq up -d
#    docker-compose --profile clickhouse up -d
#    docker-compose --profile watchtower up -d  # Auto-update containers
#
# 3. Run multiple profiles:
#    docker-compose --profile database --profile app up -d
#    docker-compose --profile analytics up -d  # RabbitMQ + ClickHouse
#
# 4. Individual files (each uses its own .env):
#    cd database && docker-compose up -d
#    cd analytics/rabbitmq && docker-compose up -d
#
# 5. Stack-based:
#    docker-compose -f docker-compose.appstack.yml up -d
#
# =============================================================================

# Include all service compose files
include:
  - path: database/docker-compose.yml
  - path: migration/docker-compose.yml
  - path: storage/docker-compose.yml
  - path: stream/docker-compose.yml
  - path: app/docker-compose.yml
  - path: analytics/rabbitmq/docker-compose.yml
  - path: analytics/clickhouse/docker-compose.yml

  # Monitoring services
  - path: monitoring/docker-compose.yml

  # Analytics services
  - path: analytics/pipeline/docker-compose.yml

# Watchtower service for automatic container updates
services:
  dashboard:
    image: beesarid/nai-controll:latest
    profiles: ["dashboard"]
    container_name: dashboard
    restart: unless-stopped
    ports:
      - "3030:3000"
    environment:
      - NODE_ENV=production
      - PORT=3000
      - PROJECT_ROOT=/nayarta-onprem-compose
    volumes:
      # Bind mount the entire nayarta-onprem-compose project (parent directory)
      # This allows editing files in the project from within the container
      - ./:/nayarta-onprem-compose:rw
      # Mount Docker socket for Docker API access
      - /var/run/docker.sock:/var/run/docker.sock:ro
    networks:
      - nayarta-network
    labels:
      - "com.project.name=nayarta"
      - "com.project.profile=control"

  watchtower:
    image: containrrr/watchtower:latest
    container_name: nayarta-watchtower
    restart: unless-stopped
    profiles: ["all", "watchtower"]
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
    labels:
      - "com.project.name=nayarta"
      - "com.project.profile=watchtower"
    environment:
      # Check for updates every 1 hour (3600 seconds)
      - WATCHTOWER_POLL_INTERVAL=300
      # Clean up old images after updating
      - WATCHTOWER_CLEANUP=true
      # Include stopped containers
      - WATCHTOWER_INCLUDE_STOPPED=true
      # Include restartable containers
      - WATCHTOWER_INCLUDE_RESTARTING=true
      # Send notifications (optional - uncomment and configure if needed)
      - WATCHTOWER_LABEL_ENABLE=true
      # - WATCHTOWER_NOTIFICATIONS=slack
      # - WATCHTOWER_NOTIFICATION_SLACK_HOOK_URL=your-webhook-url
    # Only watch containers with the label com.centurylinklabs.watchtower.enable=true
    # This ensures only specific services (api, admin, frontend) are monitored
    # Interval: 3600 seconds = 1 hour
    # command: --interval 3600 --cleanup --include-restarting --label-enable
    # Note: Watchtower doesn't need to be on the application network
    # It monitors containers via the Docker socket
